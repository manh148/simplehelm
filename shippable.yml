# Language setting
language: node_js

# Version number
node_js:
  - 0.10

env:
  global:
    - TEST=true
    - AMAZON_ECR_URL=412520076220.dkr.ecr.us-west-2.amazonaws.com
    - MYENV="im from env"

build:

  ci:
    - echo "$HOME"
    - echo "$USER"
    - sudo docker -v
    - echo "$BRANCH.$SHIPPABLE_BUILD_NUMBER"
    - MYCI="im from ci"
    - MYENV="actually updated in ci!"

  post_ci:
    - echo "post_ci section"
    - docker build -t trriplejay/simpleserver:$BRANCH.$BUILD_NUMBER .
    #- sudo docker build -t trriplejay/simpleserver:$BRANCH.$BUILD_NUMBER --build-arg mytag=$BRANCH.$BUILD_NUMBER .

    # ECR
    #- docker tag trriplejay/simpleserver:$BRANCH.$BUILD_NUMBER $AMAZON_ECR_URL/trriplejaytest:$BRANCH.$BUILD_NUMBER
    #- docker push $AMAZON_ECR_URL/trriplejaytest:$BRANCH.$BUILD_NUMBER
    - docker push trriplejay/simpleserver:$BRANCH.$BUILD_NUMBER
    - MYPOSTCI="im from post_ci"
    - apt-get update
    - apt-get install python-dev
    # need to upgrade botocore due to a problem with ebs
    - pip install --upgrade botocore

  on_success:
    - echo "huzzah!"

integrations:
  hub:
    - integrationName: "trriplejay docker hub"
      type: docker
      branches:
        only:
          - master
    #- integrationName: "shippable demo ecr"
    #  type: ecr
    #  region: us-west-2

  notifications:
    - integrationName: irc
      type: irc
      recipients:
        - "irc.rizon.net#testshippable"
      branches:
        only:
          - master
      on_success: always
      on_failure: always

    # - integrationName: "ci trigger for simple-image"
    #   type: webhook
    #   payload:
    #     - versionName=$BRANCH.$BUILD_NUMBER
    #   on_success: always
    #   on_failure: never
    #
    # - integrationName: "ci trigger for nginx-image"
    #   type: webhook
    #   payload:
    #     - versionName=stable
    #   on_success: always
    #   on_failure: never



#    - integrationName: test_start_success
#      type: webhook
#      payload:
#        - ENV=$MYENV
#        - CI=$MYCI
#        - POSTCI=$MYPOSTCI
#        - BUILDNUM=$BUILD_NUMBER
#        - dummy=string
#      on_success: always
#      on_start: always

  deploy:
   - integrationName: "shippable demo ecs"
     type: aws
     application_name: "trriplejayEBTest"
     env_name: "trriplejayebtest-env"
     region: "eu-west-1"
     image_name: "trriplejay/simpleserver"
     image_tag: "$BRANCH.$SHIPPABLE_BUILD_NUMBER"
